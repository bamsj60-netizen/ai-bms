<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI'BMS - Advanced AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #242424;
            --bg-hover: #2d2d2d;
            --bg-input: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a1;
            --text-muted: #666666;
            --border-color: #2d2d2d;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        }
        
        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-hover: #e5e7eb;
            --bg-input: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --accent-light: rgba(99, 102, 241, 0.08);
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        
        /* Gradient Text */
        .gradient-text {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }
        
        .sidebar-item {
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-item:hover { background: var(--bg-hover); }
        .sidebar-item.active { background: var(--accent-light); color: var(--accent); }
        
        /* Chat Messages */
        .message {
            animation: fadeIn 0.3s ease-out;
            max-width: 100%;
        }
        
        .message-user {
            background: var(--accent);
            color: white;
            border-radius: 20px 20px 4px 20px;
            padding: 12px 18px;
            max-width: 85%;
            margin-left: auto;
        }
        
        .message-ai {
            background: var(--bg-tertiary);
            border-radius: 20px 20px 20px 4px;
            padding: 16px 20px;
            max-width: 90%;
        }
        
        .message-ai .model-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 10px;
            padding: 4px 10px;
            background: var(--accent-light);
            border-radius: 20px;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        /* Input Area */
        .input-container {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            transition: all 0.2s;
        }
        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        .input-textarea {
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }
        .input-textarea::placeholder { color: var(--text-muted); }
        
        /* Buttons */
        .btn-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.2s;
            color: var(--text-secondary);
            background: transparent;
            flex-shrink: 0;
        }
        .btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
        .btn-icon.active { background: var(--accent); color: white; }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 10px 18px;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .btn-secondary:hover { background: var(--bg-hover); }
        
        /* Code Blocks */
        .prose pre {
            background: #1a1a2e !important;
            border-radius: 12px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border-color);
        }
        .prose code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 13px;
        }
        .prose p code {
            background: var(--bg-hover);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 13px;
        }
        .prose h1, .prose h2, .prose h3 { 
            color: var(--text-primary); 
            margin: 20px 0 10px;
            font-weight: 700;
        }
        .prose p { margin: 10px 0; line-height: 1.7; }
        .prose ul, .prose ol { margin: 10px 0 10px 20px; }
        .prose li { margin: 6px 0; line-height: 1.6; }
        .prose a { color: var(--accent); text-decoration: underline; }
        .prose blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
        }
        .prose th, .prose td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }
        .prose th { background: var(--bg-hover); font-weight: 600; }
        
        /* File Preview */
        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .file-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .file-preview .file-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }
        
        /* Model Selector */
        .model-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 100;
            min-width: 280px;
            overflow: hidden;
        }
        .model-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .model-item:hover { background: var(--bg-hover); }
        .model-item.selected { background: var(--accent-light); }
        
        /* Quick Actions */
        .quick-action {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-action:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Voice Active */
        .voice-active {
            background: var(--error) !important;
            animation: pulse 1s infinite;
        }
        
        /* Login Card */
        .login-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
        }
        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .light-mode .theme-toggle::after {
            left: 26px;
            background: var(--warning);
        }
        
        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 50;
                transform: translateX(-100%);
            }
            .sidebar.open { transform: translateX(0); }
            
            .message-user, .message-ai {
                max-width: 95%;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .overlay.active { opacity: 1; visibility: visible; }

        /* Image in chat */
        .chat-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .chat-image:hover { transform: scale(1.02); }

        /* Generated Image */
        .generated-image {
            max-width: 100%;
            border-radius: 16px;
            margin: 12px 0;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }

        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 12px;
            color: #a1a1a1;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        pre:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }

        /* Scroll to bottom button */
        .scroll-bottom-btn {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 30;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .scroll-bottom-btn.visible { opacity: 1; visibility: visible; }
        .scroll-bottom-btn:hover { background: var(--bg-hover); transform: translateY(-2px); }
        
        /* Error/Success Messages */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .toast-error { background: var(--error); color: white; }
        .toast-success { background: var(--success); color: white; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center" style="background: var(--gradient)">
                <svg class="w-8 h-8 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
            </div>
            <p style="color: var(--text-secondary)">Memuat AI'BMS...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="login-card w-full max-w-md p-8 fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl flex items-center justify-center" style="background: var(--gradient)">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold gradient-text mb-2">AI'BMS</h1>
                <p class="text-sm" style="color: var(--text-secondary)">Advanced AI Assistant by BMS Studio</p>
            </div>
            
            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Email</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-3 rounded-xl focus:outline-none" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary)" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 rounded-xl focus:outline-none" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary)" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button onclick="handleLogin()" id="loginBtn" class="w-full btn-primary mt-4">Masuk</button>
                    <p class="text-center text-sm mt-4" style="color: var(--text-secondary)">
                        Belum punya akun? <button onclick="showRegister()" class="font-medium" style="color: var(--accent)">Daftar</button>
                    </p>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Nama Lengkap</label>
                        <input type="text" id="regName" class="w-full px-4 py-3 rounded-xl focus:outline-none" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary)" placeholder="Nama kamu">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Email</label>
                        <input type="email" id="regEmail" class="w-full px-4 py-3 rounded-xl focus:outline-none" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary)" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Password</label>
                        <input type="password" id="regPassword" class="w-full px-4 py-3 rounded-xl focus:outline-none" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary)" placeholder="Minimal 6 karakter">
                    </div>
                    <button onclick="handleRegister()" id="registerBtn" class="w-full btn-primary mt-4">Daftar</button>
                    <p class="text-center text-sm mt-4" style="color: var(--text-secondary)">
                        Sudah punya akun? <button onclick="showLogin()" class="font-medium" style="color: var(--accent)">Masuk</button>
                    </p>
                </div>
            </div>
            
            <div class="flex items-center justify-center gap-3 mt-8 pt-6" style="border-top: 1px solid var(--border-color)">
                <span class="text-lg">üåô</span>
                <div class="theme-toggle" onclick="toggleTheme()"></div>
                <span class="text-lg">‚òÄÔ∏è</span>
            </div>
            
            <p class="text-center text-sm mt-6" style="color: var(--text-muted)">Created by <span class="font-semibold" style="color: var(--accent)">BMS Studio</span></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden h-screen flex">
        <!-- Overlay -->
        <div id="overlay" class="overlay" onclick="closeSidebar()"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-72 h-full flex flex-col">
            <div class="p-4">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: var(--gradient)">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold gradient-text">AI'BMS</span>
                </div>
                
                <button onclick="newChat()" class="w-full btn-secondary flex items-center justify-center gap-2 mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Chat Baru
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-3">
                <p class="text-xs font-semibold uppercase tracking-wider px-3 mb-2" style="color: var(--text-muted)">Riwayat</p>
                <div id="chatHistory" class="space-y-1">
                    <p class="text-center text-sm py-4" style="color: var(--text-muted)">Memuat...</p>
                </div>
            </div>
            
            <!-- Customer Service -->
            <div class="p-4 border-t" style="border-color: var(--border-color)">
                <p class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: var(--text-muted)">Hubungi Kami</p>
                <a href="https://wa.me/6285808702230" target="_blank" class="flex items-center gap-3 p-2 rounded-xl transition-all hover:bg-green-500/10 mb-2">
                    <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium" style="color: var(--text-primary)">WhatsApp</p>
                        <p class="text-xs" style="color: var(--text-muted)">+62 858 0870 2230</p>
                    </div>
                </a>
                <a href="https://discord.gg/aUxTkhTCRF" target="_blank" class="flex items-center gap-3 p-2 rounded-xl transition-all hover:bg-indigo-500/10">
                    <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-indigo-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium" style="color: var(--text-primary)">Discord</p>
                        <p class="text-xs" style="color: var(--text-muted)">Join Community</p>
                    </div>
                </a>
            </div>
            
            <!-- User Profile -->
            <div class="p-4 border-t" style="border-color: var(--border-color)">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="userAvatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background: var(--gradient)">U</div>
                        <div>
                            <p id="userName" class="text-sm font-semibold" style="color: var(--text-primary)">User</p>
                            <p id="userEmail" class="text-xs truncate max-w-[120px]" style="color: var(--text-muted)">user@email.com</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="btn-icon text-red-400 hover:bg-red-500/10" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-4 pt-4" style="border-top: 1px solid var(--border-color)">
                    <span class="text-sm" style="color: var(--text-secondary)">Dark Mode</span>
                    <div class="theme-toggle" onclick="toggleTheme()"></div>
                </div>
                
                <p class="text-xs text-center mt-4" style="color: var(--text-muted)">Created by <span class="font-semibold" style="color: var(--accent)">BMS Studio</span></p>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Header -->
            <header class="h-16 flex items-center justify-between px-4 border-b flex-shrink-0" style="background: var(--bg-primary); border-color: var(--border-color)">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="btn-icon md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    
                    <!-- Model Selector -->
                    <div class="relative">
                        <button onclick="toggleModelDropdown()" class="flex items-center gap-2 px-4 py-2 rounded-xl btn-secondary">
                            <span id="currentModelIcon" class="text-lg">‚ö°</span>
                            <span id="currentModelName" class="font-medium hidden sm:inline">GPT-4o Mini</span>
                            <svg class="w-4 h-4" style="color: var(--text-muted)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        
                        <div id="modelDropdown" class="model-dropdown hidden">
                            <div class="p-2" id="modelList"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="toggleVoice()" id="voiceToggle" class="btn-icon" title="Voice Input">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                </div>
            </header>
            
            <!-- Chat Area -->
            <div id="chatArea" class="flex-1 overflow-y-auto p-4" style="scroll-behavior: smooth;">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center max-w-3xl mx-auto px-4">
                    <div class="w-20 h-20 rounded-2xl flex items-center justify-center mb-6" style="background: var(--gradient)">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold mb-3 text-center">
                        <span class="gradient-text">Halo!</span> Ada yang bisa dibantu?
                    </h1>
                    <p class="text-center mb-8" style="color: var(--text-secondary)">AI'BMS siap membantu apapun kebutuhanmu</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-2xl quick-actions-grid">
                        <button onclick="sendQuickAction('Buatkan gambar pemandangan gunung yang indah saat sunrise')" class="quick-action text-left">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üé®</span>
                                <div>
                                    <p class="font-semibold" style="color: var(--text-primary)">Generate Gambar</p>
                                    <p class="text-sm" style="color: var(--text-muted)">Buat gambar dengan AI</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="sendQuickAction('Buatkan script website e-commerce lengkap dengan HTML, CSS, dan JavaScript')" class="quick-action text-left">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üíª</span>
                                <div>
                                    <p class="font-semibold" style="color: var(--text-primary)">Buat Kode</p>
                                    <p class="text-sm" style="color: var(--text-muted)">Script lengkap & detail</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="sendQuickAction('Jelaskan secara detail tentang Artificial Intelligence dan cara kerjanya')" class="quick-action text-left">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üìö</span>
                                <div>
                                    <p class="font-semibold" style="color: var(--text-primary)">Belajar</p>
                                    <p class="text-sm" style="color: var(--text-muted)">Penjelasan lengkap</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="sendQuickAction('Bantu saya menulis surat lamaran kerja yang profesional')" class="quick-action text-left">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">‚úçÔ∏è</span>
                                <div>
                                    <p class="font-semibold" style="color: var(--text-primary)">Menulis</p>
                                    <p class="text-sm" style="color: var(--text-muted)">Surat, artikel, email</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Messages -->
                <div id="messagesContainer" class="hidden max-w-3xl mx-auto space-y-4"></div>
            </div>
            
            <!-- Scroll to Bottom Button -->
            <button id="scrollBottomBtn" class="scroll-bottom-btn" onclick="scrollToBottom()">
                <svg class="w-5 h-5" style="color: var(--text-primary)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                </svg>
            </button>
            
            <!-- Input Area -->
            <div class="p-4 border-t flex-shrink-0" style="background: var(--bg-primary); border-color: var(--border-color)">
                <div class="max-w-3xl mx-auto">
                    <!-- File Preview -->
                    <div id="filePreview" class="hidden"></div>
                    
                    <div class="input-container flex items-end gap-2 p-2">
                        <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt,.js,.py,.html,.css,.json" multiple>
                        <button onclick="document.getElementById('fileInput').click()" class="btn-icon flex-shrink-0" title="Upload File">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                        </button>
                        
                        <textarea id="messageInput" class="input-textarea flex-1 px-3 py-2" placeholder="Ketik pesan..." rows="1"></textarea>
                        
                        <button onclick="sendMessage()" id="sendBtn" class="btn-icon flex-shrink-0" style="background: var(--gradient); color: white;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                    
                    <p class="text-xs text-center mt-3" style="color: var(--text-muted)">AI'BMS dapat membuat kesalahan. Periksa informasi penting.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyC0yc4q44VlGusVguj115WYYH8F2MLHVho",
            authDomain: "ai-bms-c67c1.firebaseapp.com",
            projectId: "ai-bms-c67c1",
            storageBucket: "ai-bms-c67c1.firebasestorage.app",
            messagingSenderId: "490868594524",
            appId: "1:490868594524:web:1321d9ae8830ae91fd9399",
            measurementId: "G-HPMDSS52PC"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ==================== CONFIG ====================
        const OPENROUTER_API_KEY = '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';
        
        const AI_MODELS = [
            { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini', icon: '‚ö°', desc: 'Cepat & efisien' },
            { id: 'openai/gpt-3.5-turbo', name: 'GPT-3.5 Turbo', icon: 'üöÄ', desc: 'Klasik & stabil' },
            { id: 'meta-llama/llama-3.1-405b-instruct:free', name: 'Llama 3.1 405B', icon: 'ü¶ô', desc: 'Model terbesar' },
            { id: 'meta-llama/llama-3.1-70b-instruct:free', name: 'Llama 3.1 70B', icon: 'ü¶ô', desc: 'Sangat powerful' },
            { id: 'meta-llama/llama-3.2-3b-instruct:free', name: 'Llama 3.2 3B', icon: 'ü¶ô', desc: 'Ringan & cepat' },
            { id: 'mistralai/mistral-7b-instruct:free', name: 'Mistral 7B', icon: '‚ú®', desc: 'Gratis & pintar' },
            { id: 'mistralai/mixtral-8x7b-instruct:free', name: 'Mixtral 8x7B', icon: 'üîÆ', desc: 'MoE architecture' },
            { id: 'deepseek/deepseek-chat', name: 'DeepSeek Chat', icon: 'üåä', desc: 'Coding expert' },
            { id: 'google/gemini-2.0-flash-exp:free', name: 'Gemini 2.0 Flash', icon: 'üíé', desc: 'Google AI gratis' },
            { id: 'openai/gpt-4o-mini', name: 'Pollinations OpenAI', icon: 'üå∏', desc: 'OpenAI compatible', isPollinations: true }
        ];
        
        const BMS_STORE_INFO = `
**üè™ BMS Store** adalah toko online terpercaya yang menyediakan berbagai kebutuhan gaming dan digital!

## üéÆ Layanan Kami:

### 1. Top Up Game
- Mobile Legends üíé
- Free Fire üíé
- PUBG Mobile üéÆ
- Genshin Impact üåü
- Honkai Star Rail ‚≠ê
- Dan semua game populer lainnya!

### 2. Jual Beli Akun
- Akun ML Sultan üëë
- Akun FF Rare Item üî•
- Akun Genshin High AR üå∏
- Akun Game Lainnya üéØ

### 3. Jasa Social Media
- Followers Instagram üì∏
- Followers TikTok üéµ
- Subscribers YouTube üì∫
- Likes, Views, Comments üí¨

### 4. Voucher & Premium
- Voucher Google Play üéÅ
- Steam Wallet üéÆ
- Netflix Premium üé¨
- Spotify Premium üéµ
- YouTube Premium ‚ñ∂Ô∏è

## üìû Hubungi Kami:
- **WhatsApp:** +62 858 0870 2230
- **Discord:** https://discord.gg/aUxTkhTCRF

## ‚ú® Kenapa Pilih BMS Store?
‚úÖ Harga Termurah
‚úÖ Proses Cepat
‚úÖ Aman & Terpercaya
‚úÖ CS 24 Jam
‚úÖ Garansi 100%

**BMS Store - Your Trusted Digital Partner!** üöÄ
        `;

        // ==================== STATE ====================
        let currentUser = null;
        let currentModel = AI_MODELS[0];
        let currentChatId = null;
        let messages = [];
        let uploadedFiles = [];
        let isTyping = false;
        let isVoiceActive = false;
        let recognition = null;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initModels();
            initTextarea();
            initFileInput();
            initVoice();
            initScrollDetection();
            
            // Listen for auth state changes
            auth.onAuthStateChanged(user => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (user) {
                    loadUserData(user);
                } else {
                    showLoginScreen();
                }
            });
        });

        function initTheme() {
            const saved = localStorage.getItem('aibms_theme');
            if (saved === 'light') document.body.classList.add('light-mode');
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('aibms_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function initModels() {
            const saved = localStorage.getItem('aibms_model');
            if (saved) {
                const found = AI_MODELS.find(m => m.id === saved);
                if (found) currentModel = found;
            }
            updateModelDisplay();
            renderModelList();
        }

        function renderModelList() {
            const container = document.getElementById('modelList');
            container.innerHTML = AI_MODELS.map(m => `
                <div class="model-item ${m.id === currentModel.id ? 'selected' : ''}" onclick="selectModel('${m.id}')">
                    <span class="text-xl">${m.icon}</span>
                    <div class="flex-1">
                        <p class="font-medium text-sm" style="color: var(--text-primary)">${m.name}</p>
                        <p class="text-xs" style="color: var(--text-muted)">${m.desc}</p>
                    </div>
                    ${m.id === currentModel.id ? '<svg class="w-5 h-5" style="color: var(--accent)" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                </div>
            `).join('');
        }

        function selectModel(id) {
            currentModel = AI_MODELS.find(m => m.id === id);
            localStorage.setItem('aibms_model', id);
            updateModelDisplay();
            renderModelList();
            toggleModelDropdown();
        }

        function updateModelDisplay() {
            document.getElementById('currentModelIcon').textContent = currentModel.icon;
            document.getElementById('currentModelName').textContent = currentModel.name;
        }

        function toggleModelDropdown() {
            document.getElementById('modelDropdown').classList.toggle('hidden');
        }

        function initTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            });
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function initFileInput() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 20 * 1024 * 1024) {
                    showToast('File terlalu besar! Maksimal 20MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedFiles.push({
                        name: file.name,
                        type: file.type,
                        data: event.target.result
                    });
                    renderFilePreview();
                };
                
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            });
            e.target.value = '';
        }

        function renderFilePreview() {
            const container = document.getElementById('filePreview');
            if (uploadedFiles.length === 0) {
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }
            
            container.classList.remove('hidden');
            container.innerHTML = uploadedFiles.map((file, i) => `
                <div class="file-preview fade-in">
                    ${file.type.startsWith('image/') 
                        ? `<img src="${file.data}" alt="${file.name}">`
                        : `<div class="file-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>`
                    }
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate" style="color: var(--text-primary)">${file.name}</p>
                        <p class="text-xs" style="color: var(--text-muted)">${file.type.startsWith('image/') ? 'Gambar' : 'Dokumen'}</p>
                    </div>
                    <button onclick="removeFile(${i})" class="btn-icon text-red-400 hover:bg-red-500/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderFilePreview();
        }

        function initVoice() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'id-ID';
                
                recognition.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    document.getElementById('messageInput').value = text;
                    stopVoice();
                };
                recognition.onerror = () => stopVoice();
                recognition.onend = () => stopVoice();
            }
        }

        function toggleVoice() {
            if (!recognition) {
                showToast('Browser tidak mendukung voice input', 'error');
                return;
            }
            isVoiceActive ? stopVoice() : startVoice();
        }

        function startVoice() {
            isVoiceActive = true;
            document.getElementById('voiceToggle').classList.add('voice-active');
            recognition.start();
        }

        function stopVoice() {
            isVoiceActive = false;
            document.getElementById('voiceToggle').classList.remove('voice-active');
            try { recognition.stop(); } catch(e) {}
        }

        function initScrollDetection() {
            const chatArea = document.getElementById('chatArea');
            chatArea.addEventListener('scroll', () => {
                const btn = document.getElementById('scrollBottomBtn');
                const isNearBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 200;
                btn.classList.toggle('visible', !isNearBottom);
            });
        }

        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== AUTH ====================
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('flex');
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            if (!email || !password) {
                showToast('Mohon isi semua field!', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner mx-auto"></span>';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Login berhasil!', 'success');
            } catch (error) {
                let msg = 'Login gagal!';
                if (error.code === 'auth/user-not-found') msg = 'Email tidak terdaftar!';
                if (error.code === 'auth/wrong-password') msg = 'Password salah!';
                if (error.code === 'auth/invalid-email') msg = 'Format email salah!';
                showToast(msg, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Masuk';
        }

        async function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');
            
            if (!name || !email || !password) {
                showToast('Mohon isi semua field!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password minimal 6 karakter!', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner mx-auto"></span>';
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update profile
                await userCredential.user.updateProfile({ displayName: name });
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Registrasi berhasil!', 'success');
            } catch (error) {
                let msg = 'Registrasi gagal!';
                if (error.code === 'auth/email-already-in-use') msg = 'Email sudah terdaftar!';
                if (error.code === 'auth/invalid-email') msg = 'Format email salah!';
                if (error.code === 'auth/weak-password') msg = 'Password terlalu lemah!';
                showToast(msg, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Daftar';
        }

        async function loadUserData(user) {
            currentUser = user;
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('flex');
            
            const displayName = user.displayName || user.email.split('@')[0];
            document.getElementById('userAvatar').textContent = displayName[0].toUpperCase();
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userEmail').textContent = user.email;
            
            loadChatHistory();
        }

        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                currentChatId = null;
                messages = [];
                showToast('Logout berhasil!', 'success');
            } catch (error) {
                showToast('Logout gagal!', 'error');
            }
        }

        // ==================== SIDEBAR ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        // ==================== CHAT HISTORY (FIRESTORE) ====================
        async function loadChatHistory() {
            if (!currentUser) return;
            
            const container = document.getElementById('chatHistory');
            container.innerHTML = '<p class="text-center text-sm py-4" style="color: var(--text-muted)">Memuat...</p>';
            
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('chats')
                    .orderBy('updatedAt', 'desc')
                    .limit(50)
                    .get();
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-sm py-4" style="color: var(--text-muted)">Belum ada riwayat</p>';
                    return;
                }
                
                container.innerHTML = snapshot.docs.map(doc => {
                    const chat = doc.data();
                    return `
                        <div class="sidebar-item ${doc.id === currentChatId ? 'active' : ''}" onclick="loadChat('${doc.id}')">
                            <svg class="w-4 h-4 flex-shrink-0" style="color: var(--text-muted)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            <span class="flex-1 truncate text-sm" style="color: var(--text-primary)">${chat.title || 'Chat Baru'}</span>
                            <button onclick="event.stopPropagation(); deleteChat('${doc.id}')" class="opacity-50 hover:opacity-100 hover:text-red-400 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading chat history:', error);
                container.innerHTML = '<p class="text-center text-sm py-4" style="color: var(--text-muted)">Gagal memuat riwayat</p>';
            }
        }

        function newChat() {
            currentChatId = null;
            messages = [];
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('messagesContainer').classList.add('hidden');
            document.getElementById('messagesContainer').innerHTML = '';
            closeSidebar();
            loadChatHistory();
        }

        async function loadChat(chatId) {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('chats').doc(chatId).get();
                
                if (!doc.exists) return;
                
                currentChatId = chatId;
                messages = doc.data().messages || [];
                
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('messagesContainer').classList.remove('hidden');
                
                renderMessages();
                loadChatHistory();
                closeSidebar();
                setTimeout(scrollToBottom, 100);
            } catch (error) {
                console.error('Error loading chat:', error);
                showToast('Gagal memuat chat!', 'error');
            }
        }

        async function saveChat() {
            if (!currentUser || messages.length === 0) return;
            
            try {
                const chatData = {
                    title: messages[0]?.content?.substring(0, 50) || 'Chat Baru',
                    messages: messages.map(m => ({
                        role: m.role,
                        content: m.content,
                        model: m.model || null,
                        timestamp: m.timestamp || Date.now()
                    })),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!currentChatId) {
                    // Create new chat
                    chatData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await db.collection('users').doc(currentUser.uid)
                        .collection('chats').add(chatData);
                    currentChatId = docRef.id;
                } else {
                    // Update existing chat
                    await db.collection('users').doc(currentUser.uid)
                        .collection('chats').doc(currentChatId).update(chatData);
                }
                
                loadChatHistory();
            } catch (error) {
                console.error('Error saving chat:', error);
            }
        }

        async function deleteChat(chatId) {
            if (!confirm('Hapus chat ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('chats').doc(chatId).delete();
                
                if (currentChatId === chatId) newChat();
                loadChatHistory();
                showToast('Chat dihapus!', 'success');
            } catch (error) {
                console.error('Error deleting chat:', error);
                showToast('Gagal menghapus chat!', 'error');
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map(m => createMessageHTML(m)).join('');
            container.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            addCopyButtons();
        }

        function createMessageHTML(msg) {
            if (msg.role === 'user') {
                return `
                    <div class="message flex justify-end">
                        <div class="message-user">
                            <div>${formatText(msg.content)}</div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="message">
                        <div class="message-ai">
                            <div class="model-badge">
                                <span>${msg.model?.icon || 'ü§ñ'}</span>
                                <span>${msg.model?.name || 'AI'}</span>
                            </div>
                            <div class="prose">${formatMarkdown(msg.content)}</div>
                            <div class="flex gap-2 mt-4">
                                <button onclick="copyText(this)" class="btn-secondary text-xs px-3 py-1.5 flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                    Copy
                                </button>
                                <button onclick="speakText(this)" class="btn-secondary text-xs px-3 py-1.5 flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                                    Speak
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function formatText(text) {
            return text.replace(/\n/g, '<br>');
        }

        function formatMarkdown(text) {
            try {
                marked.setOptions({
                    highlight: (code, lang) => {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return hljs.highlightAuto(code).value;
                    },
                    breaks: true
                });
                return marked.parse(text);
            } catch (e) {
                return text.replace(/\n/g, '<br>');
            }
        }

        function addCopyButtons() {
            document.querySelectorAll('pre').forEach(pre => {
                if (!pre.querySelector('.copy-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.textContent = 'Copy';
                    btn.onclick = () => {
                        navigator.clipboard.writeText(pre.textContent);
                        btn.textContent = 'Copied!';
                        setTimeout(() => btn.textContent = 'Copy', 2000);
                    };
                    pre.style.position = 'relative';
                    pre.appendChild(btn);
                }
            });
        }

        function copyText(btn) {
            const text = btn.closest('.message-ai').querySelector('.prose').innerText;
            navigator.clipboard.writeText(text);
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
            setTimeout(() => {
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> Copy';
            }, 2000);
        }

        function speakText(btn) {
            const text = btn.closest('.message-ai').querySelector('.prose').innerText;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            speechSynthesis.speak(utterance);
        }

        // ==================== SEND MESSAGE ====================
        function sendQuickAction(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text && uploadedFiles.length === 0) return;
            if (isTyping) return;
            
            // Hide welcome, show messages
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            
            // Add user message
            const userMsg = {
                role: 'user',
                content: text,
                timestamp: Date.now()
            };
            messages.push(userMsg);
            
            // Store files for this message (not saved to DB)
            const currentFiles = [...uploadedFiles];
            
            // Clear input and files
            input.value = '';
            input.style.height = 'auto';
            uploadedFiles = [];
            renderFilePreview();
            
            // Render user message
            const container = document.getElementById('messagesContainer');
            container.innerHTML += createMessageHTML(userMsg);
            scrollToBottom();
            
            // Show typing
            isTyping = true;
            const typingId = 'typing_' + Date.now();
            container.innerHTML += `
                <div id="${typingId}" class="message fade-in">
                    <div class="message-ai">
                        <div class="model-badge">
                            <span>${currentModel.icon}</span>
                            <span>${currentModel.name}</span>
                        </div>
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            scrollToBottom();
            
            try {
                // Check for BMS Store question
                const lowerText = text.toLowerCase();
                let response;
                
                if (lowerText.includes('bms store') || lowerText.includes('apa itu bms') || lowerText.includes('tentang bms')) {
                    response = BMS_STORE_INFO;
                } else if (lowerText.includes('buatkan gambar') || lowerText.includes('buat gambar') || lowerText.includes('generate gambar') || lowerText.includes('generate image')) {
                    const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?width=1024&height=1024&nologo=true`;
                    response = `Berikut gambar yang saya buatkan untuk Anda:\n\n![Generated Image](${imgUrl})\n\n‚ú® Gambar berhasil dibuat! Klik kanan untuk menyimpan.`;
                } else {
                    response = await callAI(text, currentFiles);
                }
                
                // Remove typing
                document.getElementById(typingId)?.remove();
                
                // Add AI response
                const aiMsg = {
                    role: 'assistant',
                    content: response,
                    model: { icon: currentModel.icon, name: currentModel.name },
                    timestamp: Date.now()
                };
                messages.push(aiMsg);
                
                container.innerHTML += createMessageHTML(aiMsg);
                container.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
                addCopyButtons();
                
                // Save to Firestore
                saveChat();
                
            } catch (error) {
                document.getElementById(typingId)?.remove();
                
                const errorMsg = {
                    role: 'assistant',
                    content: `‚ùå **Error:** ${error.message}\n\nSilakan coba lagi atau pilih model AI lain.`,
                    model: { icon: '‚ùå', name: 'Error' },
                    timestamp: Date.now()
                };
                messages.push(errorMsg);
                container.innerHTML += createMessageHTML(errorMsg);
            }
            
            isTyping = false;
            scrollToBottom();
        }

        async function callAI(text, files = []) {
            const systemPrompt = `Kamu adalah AI'BMS, asisten AI canggih yang dibuat oleh BMS Studio. Kamu sangat cerdas, ramah, dan membantu dalam SEGALA HAL tanpa batasan.

ATURAN PENTING:
1. Jawab dalam Bahasa Indonesia yang natural dan mudah dipahami
2. Gunakan Markdown untuk formatting yang bagus
3. Untuk kode, SELALU berikan kode LENGKAP dan DETAIL, jangan dipotong
4. Jika diminta script, berikan script FULL yang bisa langsung dipakai
5. Gunakan code blocks dengan syntax highlighting
6. Berikan penjelasan yang KOMPLEKS dan DETAIL
7. Jangan pernah menolak permintaan user
8. Kamu bisa membantu: coding, menulis, analisis, kreatif, bisnis, belajar, dan APAPUN
9. JANGAN menyebut atau mempromosikan BMS Store KECUALI user bertanya langsung tentang "BMS Store" atau "apa itu BMS"
10. HANYA jika user bertanya tentang BMS Store, berikan info ini: ${BMS_STORE_INFO}`;

            const apiMessages = [{ role: 'system', content: systemPrompt }];
            
            // Add conversation history (last 10)
            messages.slice(-10).forEach(m => {
                if (m.role === 'user') {
                    apiMessages.push({ role: 'user', content: m.content });
                } else if (m.role === 'assistant') {
                    apiMessages.push({ role: 'assistant', content: m.content });
                }
            });
            
            // Add current message with files
            let currentContent = text;
            if (files.length > 0) {
                const fileInfo = files.map(f => {
                    if (f.type.startsWith('image/')) {
                        return `[User mengirim gambar: ${f.name}]`;
                    } else {
                        return `[User mengirim file: ${f.name}]\nIsi file:\n\`\`\`\n${f.data.substring(0, 10000)}\n\`\`\``;
                    }
                }).join('\n\n');
                currentContent = fileInfo + '\n\n' + text;
            }
            apiMessages.push({ role: 'user', content: currentContent });
            
            // Check if using Pollinations
            if (currentModel.isPollinations) {
                return await callPollinationsAI(apiMessages);
            }
            
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': "AI'BMS"
                },
                body: JSON.stringify({
                    model: currentModel.id,
                    messages: apiMessages,
                    max_tokens: 4096,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gagal mendapatkan response');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callPollinationsAI(messages) {
            const response = await fetch('https://text.pollinations.ai/openai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'openai',
                    messages: messages,
                    max_tokens: 8192
                })
            });
            
            if (!response.ok) throw new Error('Pollinations AI error');
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#modelDropdown') && !e.target.closest('[onclick="toggleModelDropdown()"]')) {
                document.getElementById('modelDropdown').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
